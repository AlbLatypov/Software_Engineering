# Linux Resource Limits

On our Storage server in Stratos Datacenter we are having some issues where nfsuser user is holding hundred of processes, which is degrading the performance of the server. Therefore, we have a requirement to limit its maximum processes. Please set its maximum process limits as below:


a. soft limit = 1026

b. hard_limit = 2025


### Решение

Сервер ststor01, пользователь natasha. Классически подключаемся по ssh.

Смотрим лимиты (только это для пользователя natasha):
```bash
[natasha@ststor01 ~]$ sudo ulimit -Sn
1024
[natasha@ststor01 ~]$ sudo ulimit -Hn
1048576
[natasha@ststor01 ~]$ 
```

Смотрим файл /etc/security/limits.conf и добавляем строчки:
```bash
#*               soft    core            0
#*               hard    rss             10000
#@student        hard    nproc           20
#@faculty        soft    nproc           20
#@faculty        hard    nproc           50
#ftp             hard    nproc           0
nfsuser          soft    nproc           1026
nfsuser          hard    nproc           2025
```

Не знаю пароль пользователя nfsuser, сбрасываю, захожу под ним и смотрю лимиты:
```bash
[nfsuser@ststor01 ~]$ ulimit -Sn
1024
[nfsuser@ststor01 ~]$ ulimit -Hn
1048576
```
Они не изменяются, сколько бы я не переподключался. Но настройки в конфиге сделаны правильно! Проверим. Лаба засчитана, но сколько бы я ни проверял заданных цифр я не увидел. Возможно нужна перезагрузка. Но этого делать нельзя.

### Дополнительная информация

- В файле /etc/security/limits.conf ---> @ - применение к группе
- изменения в файле /etc/security/limits.conf применяются только к новым сессиям пользователя. Поэтому, чтобы ограничения вступили в силу, пользователю необходимо перезайти в систему или перезагрузить сервер.
- Мягкий лимит (soft limit) - 1026 процессов. Когда количество процессов достигнет этого значения, пользователь получит предупреждение, но сможет продолжить создавать новые процессы до достижения жесткого лимита.
- Жесткий лимит (hard limit) - 2025 процессов. Когда количество процессов достигнет этого значения, пользователь не сможет создавать новые процессы, пока не завершит некоторые из существующих.

#### ChatGPT

Если лимиты, установленные в файле /etc/security/limits.conf, не применяются к пользователю, есть несколько моментов, которые стоит проверить:

- Перезагрузка системы или повторный вход пользователя:
Изменения в файле limits.conf применяются только к новым сессиям пользователя. Убедитесь, что после внесения изменений пользователь вышел из системы и снова вошел, или перезагрузите систему.

- Проверка синтаксиса файла limits.conf:
Убедитесь, что синтаксис файла limits.conf верный. Каждая строка должна содержать четыре поля: домен (пользователь или группа), тип (soft или hard), элемент (например, nproc) и значение лимита.

- Проверьте, что имя пользователя или группы указано правильно и соответствует реальному пользователю или группе в системе.

- Проверка наличия других файлов конфигурации:
Помимо /etc/security/limits.conf, лимиты могут быть заданы в других файлах, таких как /etc/security/limits.d/*.conf. Убедитесь, что в этих файлах нет конфликтующих или переопределяющих настроек для данного пользователя или группы.

- Проверка значений лимитов в сессии пользователя:
Войдите в систему под учетной записью пользователя, для которого установлены лимиты.
Выполните команду ulimit -a, чтобы просмотреть текущие значения лимитов для сессии пользователя.
Убедитесь, что значения лимитов соответствуют тем, которые вы установили в файле limits.conf.

- Проверка системных ограничений:
Некоторые системные ограничения могут препятствовать применению лимитов из файла limits.conf. Например, если системный лимит на количество процессов ниже, чем значение, указанное в limits.conf, то будет применяться системный лимит.

- Проверьте системные ограничения с помощью команды sysctl -a | grep fs.file-max для максимального количества открытых файлов и sysctl -a | grep kernel.pid_max для максимального количества процессов.

- Проверка прав доступа к файлу limits.conf:
Убедитесь, что файл /etc/security/limits.conf имеет правильные права доступа. Он должен быть доступен для чтения всем пользователям, но запись должна быть разрешена только суперпользователю (root).


